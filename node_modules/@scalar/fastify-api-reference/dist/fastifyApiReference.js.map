{
  "version": 3,
  "sources": ["../src/fastifyApiReference.ts"],
  "sourcesContent": ["import { getHtmlDocument } from '@scalar/core/libs/html-rendering'\nimport { normalize, toJson, toYaml } from '@scalar/openapi-parser'\nimport type { OpenAPI } from '@scalar/openapi-types'\nimport type { FastifyBaseLogger, FastifyTypeProviderDefault, RawServerDefault } from 'fastify'\nimport fp from 'fastify-plugin'\nimport { slug } from 'github-slugger'\n\nimport type { ApiReferenceConfiguration, FastifyApiReferenceHooksOptions, FastifyApiReferenceOptions } from './types'\nimport { getJavaScriptFile } from './utils/getJavaScriptFile'\n\n/**\n * Path to the bundled Scalar JavaScript file\n */\nconst RELATIVE_JAVASCRIPT_PATH = 'js/scalar.js'\n\n/**\n * This Schema is used to hide the route from the documentation.\n *\n * We don't know whether `@fastify/swagger` is registered, but it doesn't hurt to add a schema anyway.\n *\n * @see https://github.com/fastify/fastify-swagger#hide-a-route\n */\nconst schemaToHideRoute = {\n  hide: true,\n}\n\nconst getRoutePrefix = (routePrefix?: string) => {\n  const prefix = routePrefix ?? '/reference'\n\n  // Remove trailing slash if present\n  return prefix.endsWith('/') ? prefix.slice(0, -1) : prefix\n}\n\n/**\n * Get the endpoints for the OpenAPI specification.\n */\nconst getOpenApiDocumentEndpoints = (\n  openApiDocumentEndpoints: FastifyApiReferenceOptions['openApiDocumentEndpoints'],\n) => {\n  const { json = '/openapi.json', yaml = '/openapi.yaml' } = openApiDocumentEndpoints ?? {}\n  return { json, yaml }\n}\n\n/**\n * Get the URL for the Scalar JavaScript file.\n */\nconst getJavaScriptUrl = (routePrefix?: string) =>\n  `${getRoutePrefix(routePrefix)}/${RELATIVE_JAVASCRIPT_PATH}`.replace(/\\/\\//g, '/')\n\n/**\n * The default configuration for Fastify\n */\nconst DEFAULT_CONFIGURATION: Partial<ApiReferenceConfiguration> = {\n  _integration: 'fastify',\n}\n\nconst fastifyApiReference = fp<\n  FastifyApiReferenceOptions,\n  RawServerDefault,\n  FastifyTypeProviderDefault,\n  FastifyBaseLogger\n>(\n  (fastify, options, next) => {\n    const { configuration: givenConfiguration } = options\n\n    // Merge the defaults\n    let configuration = {\n      ...DEFAULT_CONFIGURATION,\n      ...givenConfiguration,\n    }\n\n    const specSource = (() => {\n      const { content, url } = configuration ?? {}\n      if (content) {\n        return {\n          type: 'content' as const,\n          get: () => {\n            if (typeof content === 'function') {\n              return content()\n            }\n            return content\n          },\n        }\n      }\n      if (url) {\n        return {\n          type: 'url' as const,\n          get: () => url,\n        }\n      }\n\n      // Even if @fastify/swagger is loaded, when the `decorator` option is set, the `swagger` function is not available.\n      if (fastify.hasPlugin('@fastify/swagger') && typeof fastify.swagger === 'function') {\n        return {\n          type: 'swagger' as const,\n          get: () => fastify.swagger(),\n        }\n      }\n\n      return void 0\n    })()\n\n    // If no OpenAPI specification is passed and @fastify/swagger isn't loaded, show a warning.\n    if (!specSource && !configuration.sources) {\n      fastify.log.warn(\n        \"[@scalar/fastify-api-reference] You didn't provide a `content`, `url`, `sources` or @fastify/swagger could not be found. Please provide one of these options.\",\n      )\n\n      return next()\n    }\n\n    // Read the JavaScript file once.\n    const fileContent = getJavaScriptFile()\n\n    const hooks: FastifyApiReferenceHooksOptions = {}\n    if (options.hooks) {\n      const additionalHooks: (keyof FastifyApiReferenceHooksOptions)[] = ['onRequest', 'preHandler']\n\n      for (const hook of additionalHooks) {\n        if (options.hooks[hook]) {\n          hooks[hook] = options.hooks[hook]\n        }\n      }\n    }\n\n    const getSpecFilenameSlug = (spec: OpenAPI.Document) => {\n      // Same GitHub Slugger and default file name as in `@scalar/api-reference`, when generating the download\n      return slug(spec?.specification?.info?.title ?? 'spec')\n    }\n\n    // Only expose the endpoints if specSource is available\n    if (specSource) {\n      const openApiSpecUrlJson = `${getRoutePrefix(options.routePrefix)}${getOpenApiDocumentEndpoints(options.openApiDocumentEndpoints).json}`\n      fastify.route({\n        method: 'GET',\n        url: openApiSpecUrlJson,\n        schema: schemaToHideRoute,\n        ...hooks,\n        ...(options.logLevel && { logLevel: options.logLevel }),\n        handler(_, reply) {\n          const spec = normalize(specSource.get())\n          const filename = getSpecFilenameSlug(spec)\n          const json = JSON.parse(toJson(spec)) // parsing minifies the JSON\n\n          return reply\n            .header('Content-Type', 'application/json')\n            .header('Content-Disposition', `filename=${filename}.json`)\n            .header('Access-Control-Allow-Origin', '*')\n            .header('Access-Control-Allow-Methods', '*')\n            .send(json)\n        },\n      })\n\n      const openApiSpecUrlYaml = `${getRoutePrefix(options.routePrefix)}${getOpenApiDocumentEndpoints(options.openApiDocumentEndpoints).yaml}`\n      fastify.route({\n        method: 'GET',\n        url: openApiSpecUrlYaml,\n        schema: schemaToHideRoute,\n        ...hooks,\n        ...(options.logLevel && { logLevel: options.logLevel }),\n        handler(_, reply) {\n          const spec = normalize(specSource.get())\n          const filename = getSpecFilenameSlug(spec)\n          const yaml = toYaml(spec)\n          return reply\n            .header('Content-Type', 'application/yaml')\n            .header('Content-Disposition', `filename=${filename}.yaml`)\n            .header('Access-Control-Allow-Origin', '*')\n            .header('Access-Control-Allow-Methods', '*')\n            .send(yaml)\n        },\n      })\n    }\n\n    // Redirect route without a trailing slash to force a trailing slash:\n    // We need this so the request to the JS file is relative.\n\n    // With ignoreTrailingSlash: true, fastify responds to both routes anyway.\n    const ignoreTrailingSlash =\n      // @ts-expect-error We're still on Fastify 4, this is introduced in Fastify 5\n      fastify.initialConfig?.routerOptions?.ignoreTrailingSlash === true ||\n      fastify.initialConfig?.ignoreTrailingSlash === true\n\n    if (!ignoreTrailingSlash && getRoutePrefix(options.routePrefix)) {\n      fastify.route({\n        method: 'GET',\n        url: getRoutePrefix(options.routePrefix),\n        schema: schemaToHideRoute,\n        ...hooks,\n        ...(options.logLevel && { logLevel: options.logLevel }),\n        handler(request, reply) {\n          // we are in a route without a trailing slash so redirect directly to the one with a trailing slash\n          const currentUrl = new URL(request.url, `${request.protocol}://${request.hostname}`)\n          return reply.redirect(`${currentUrl.pathname}/`, 301)\n        },\n      })\n    }\n\n    // If no theme is passed, use the default theme.\n    fastify.route({\n      method: 'GET',\n      url: `${getRoutePrefix(options.routePrefix)}/`,\n      // We don't know whether @fastify/swagger is registered, but it doesn't hurt to add a schema anyway.\n      schema: schemaToHideRoute,\n      ...hooks,\n      ...(options.logLevel && { logLevel: options.logLevel }),\n      handler(request, reply) {\n        // Redirect if it's the route without a slash\n        const currentUrl = new URL(request.url, `${request.protocol}://${request.hostname}`)\n        if (!currentUrl.pathname.endsWith('/')) {\n          return reply.redirect(`${currentUrl.pathname}/`, 301)\n        }\n\n        /**\n         * Regardless of where we source the spec from, provide it as a URL, to have the\n         * download button point to the exposed endpoint.\n         * If the URL is explicitly passed, defer to that URL instead.\n         */\n        if (specSource && specSource.type !== 'url') {\n          configuration = {\n            ...configuration,\n            // Use a relative URL in case we're proxied\n            url: `.${getOpenApiDocumentEndpoints(options.openApiDocumentEndpoints).json}`,\n          }\n        }\n\n        // Respond with the HTML document\n        return reply.header('Content-Type', 'text/html; charset=utf-8').send(\n          getHtmlDocument({\n            // We're using the bundled JS here by default, but the user can pass a CDN URL.\n            cdn: RELATIVE_JAVASCRIPT_PATH,\n            ...configuration,\n          }),\n        )\n      },\n    })\n\n    fastify.route({\n      method: 'GET',\n      url: getJavaScriptUrl(options.routePrefix),\n      // We don't know whether @fastify/swagger is registered, but it doesn't hurt to add a schema anyway.\n      schema: schemaToHideRoute,\n      ...hooks,\n      ...(options.logLevel && { logLevel: options.logLevel }),\n      handler(_, reply) {\n        return reply.header('Content-Type', 'application/javascript; charset=utf-8').send(fileContent)\n      },\n    })\n\n    next()\n  },\n  {\n    name: '@scalar/fastify-api-reference',\n  },\n)\n\nexport default fastifyApiReference\n"],
  "mappings": "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",
  "names": []
}
